name: Terraform Unit Tests
description: Runs Terraform Unit Tests Via TerraTest
inputs:
  GITHUB_TOKEN:
    description: Workflow GitHub Token (limited permissions)
    required: true

runs:
  using: "composite"
  steps:
    # - name: Setup Terratests
    #   shell: bash
    #   run: |
    #     go mod init github.com/${GITHUB_REPOSITORY}
    #     go mod tidy

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        cache: true
        cache-dependency-path: test/go.sum

    - name: Unit Tests Results
      shell: bash
      if: success() || failure()
      working-directory: test
      run: |
        # display the results in job log:
        cmd=(go test -timeout 30m)
        echo "cmd=${cmd[@]}" >> ${GITHUB_OUTPUT}

    - name: Unit Tests Summary
      shell: bash
      if: success() || failure()
      env:
        TF_CMD: ${{ steps.plan.outputs.cmd }}
      working-directory: test
      run: |
        echo ${TF_CMD}
        # go test -timeout 30m | grep -A 3000 'FAIL\|PASS' > testSummary.text

    - name: Report Unit Test Summary
      if: success() || failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ inputs.GITHUB_TOKEN }}
        script: |
          let stdout = '';
          let stderr = '';

          const options = {};
          options.listeners = {
            stdout: (data) => {
              stdout += data.toString();
            },
            stderr: (data) => {
              stderr += data.toString();
            }
          };
          await exec.exec('cat', ['test/testSummary.text'], options);

          const output = `### Unit Tests Results
          <details><summary>Show Results</summary>

          \`\`\`\n
          ${stdout}
          \`\`\`

          </details>`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
